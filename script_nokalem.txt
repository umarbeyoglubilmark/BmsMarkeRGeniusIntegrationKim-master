USE [ERULKU]
GO

/****** Object:  UserDefinedFunction [dbo].[Bmsf_125_MarkeRGeniusIntegration_Malzemeler]    Script Date: 25.12.2025 16:35:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO














 


CREATE FUNCTION [dbo].[Bmsf_125_MarkeRGeniusIntegration_Malzemeler] (
    @WHOUSENR int
)
RETURNS TABLE
AS
RETURN 
SELECT 
	* 
FROM (
SELECT
TARIH=cast(CASE	WHEN (SELECT TOP 1 ISNULL(PL.CAPIBLOCK_MODIFIEDDATE,PL.CAPIBLOCK_CREADEDDATE) FROM LG_125_PRCLIST PL WITH(NOLOCK) WHERE PL.LOGICALREF=LK_PRCLISTREF)>
			ITEMDATE
				THEN (SELECT TOP 1 ISNULL(PL.CAPIBLOCK_MODIFIEDDATE,PL.CAPIBLOCK_CREADEDDATE) FROM LG_125_PRCLIST PL WITH(NOLOCK) WHERE PL.LOGICALREF=LK_PRCLISTREF) ELSE
			ITEMDATE
		END as date), 
IBMGENIUSAMBAR
,CODE
,BARCODE
,ALCOHOL = (CASE WHEN CYPHCODE LIKE '%İÇKİ%' THEN 1 ELSE 0 END)
,EXPLANATION=dbo.BMS_FNC_PennaGeniusIntegration_CharacterFix(EXPLANATION)
,UNIT1
,UNIT1IBM=(CASE UNIT1 WHEN 'ADET' THEN '1' WHEN 'M' THEN '100' WHEN 'KG' THEN '1000' END)
,SELLING_PRICE1=	ROUND((SELECT TOP 1 PL.PRICE FROM LG_125_PRCLIST PL WITH(NOLOCK) WHERE PL.LOGICALREF=LK_PRCLISTREF),2)
,VAT_RATE
,VAT_CODE
,VAT_CODE_N
,GROUPID =
    CASE 
	       
	        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '262' THEN '1'     
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '227' THEN '2'                     -- 113 ürün
                -- 585 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1161' THEN '3'                -- 431 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1167' THEN '4'                   -- 301 ürün
        WHEN SPECODE2 = '11104' THEN '5'              -- 158 ürün
        WHEN SPECODE2 = '14202' THEN '6'          -- 775 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1176' AND SPECODE3 = '776' THEN '7'  -- 157 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1176' AND SPECODE3 = '137' THEN '8'  
		
		-- 309 ürün
        ELSE '0' 
    END
,GROUPINFO =
    CASE 
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '227' THEN 'Arian kampanya'                     -- 113 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '262' THEN 'Arzum kampanya'                     -- 585 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1161' THEN 'Hascevher kampanya'                -- 431 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1167' THEN 'Mehtap kampanya'                   -- 301 ürün
        WHEN SPECODE2 = '11104' THEN 'Bisiklet kampanyası'              -- 158 ürün
       WHEN SPECODE2 = '14202' THEN 'Twigy Terlik Grubu Yeni Yıl Kampanyası'     -- 775 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1176' AND SPECODE3 = '776' THEN 'Wk 776 kampanyası'  -- 157 ürün
        WHEN ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'') = '1176' AND SPECODE3 = '137' THEN 'Wk 137 kampanya'    -- 309 ürün
        ELSE '' 
    END
,MARKCODE=ISNULL((SELECT TOP 1 M.CODE FROM LG_125_MARK M WHERE M.LOGICALREF=MARKREF),'')

,SPECODE
,SPECODE2
,SPECODE3
,SPECODE4
,SPECODE5
,ACTIVE
 FROM (
SELECT 
	IBMGENIUSAMBAR=(SELECT TOP 1 KDD.OFFICECODE FROM  LK_125_DIVDEFAULTS KDD WITH(NOLOCK) WHERE KDD.WHOUSENR=@WHOUSENR)
	,ITEMREF=		I.LOGICALREF
	,ITEMDATE=		CASE WHEN ISNULL(I.CAPIBLOCK_MODIFIEDDATE,CONVERT(DATETIME, 0))>ISNULL(I.CAPIBLOCK_CREADEDDATE,'20230101') THEN I.CAPIBLOCK_MODIFIEDDATE ELSE I.CAPIBLOCK_CREADEDDATE END
	,I.CODE
	,I.MARKREF
	,B.BARCODE
	,EXPLANATION=	LEFT(I.NAME,20)
	,UNIT1=			(SELECT TOP 1 UL.CODE FROM LG_125_UNITSETL UL  WITH(NOLOCK) WHERE UL.MAINUNIT=1 AND UL.UNITSETREF=I.UNITSETREF)
	,LK_PRCLISTREF=	ISNULL((SELECT TOP 1 KF.LOGICALREF FROM 
						LG_125_PRCLIST KF WITH(NOLOCK)  WHERE KF.OFFICECODE=(SELECT KDD.OFFICECODE FROM 
							LK_125_DIVDEFAULTS KDD  WITH(NOLOCK) WHERE KDD.WHOUSENR=@WHOUSENR) AND KF.STREF=I.LOGICALREF AND KF.VARIANTREF=0 
								ORDER BY KF.LOGICALREF DESC),0)
				

	,VAT_RATE=I.SELLPRVAT
	,ACTIVE = I.ACTIVE
	,VAT_CODE=(SELECT TOP 1 M.KDVDEPNR FROM  LG_125_MARKET M WITH(NOLOCK)  WHERE M.ITEMREF=I.LOGICALREF)
	,VAT_CODE_N=(
	SELECT TOP 1 
    CASE M.KDVDEPNR
        WHEN 5 THEN 8
        WHEN 7 THEN 1
        WHEN 1 THEN 2
        WHEN 6 THEN 3
        WHEN 3 THEN 4
        WHEN 4 THEN 5
        ELSE M.KDVDEPNR
    END AS NCR
FROM LG_125_MARKET M WITH(NOLOCK)
WHERE M.ITEMREF = I.LOGICALREF
	)
	,SPECODE
	,SPECODE2
	,SPECODE3
	,SPECODE4
	,SPECODE5
	,CYPHCODE
FROM 
	LG_125_UNITBARCODE B  WITH(NOLOCK) LEFT JOIN LG_125_ITEMS I WITH(NOLOCK)  ON I.LOGICALREF = B.ITEMREF 
) AS TT
) AS TF
WHERE 
	TF.SELLING_PRICE1>0 AND YEAR(TF.TARIH)>=2023
GO


